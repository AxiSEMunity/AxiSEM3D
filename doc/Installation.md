[<< Back to repository](https://github.com/kuangdai/AxiSEM-3D)


# Installation
The installation of `AxiSEM3D` includes three parts: the mesher, the solver and several tools (mostly Python libraries) for pre- and post-processing.

System requirements:
* Unix-like system (`AxiSEM3D` is untested on Windows)
* C++ compiler supporting C++17 (check [C++ compiler support](https://en.cppreference.com/w/cpp/compiler_support))
* Basic development tools: `python`, `pip`, `conda` ([`Anaconda`](https://docs.anaconda.com/anaconda/install/) or [`Miniconda`](https://docs.conda.io/en/latest/miniconda.html)), `cmake` (â‰¥ 3.15.3), `wget`
* MPI (a serial build can be made but is not very useful) 



## Mesher
[`SalvusMeshLite`](https://gitlab.com/Salvus/SalvusMeshLite) is the mesher for `AxiSEM3D`. Its installation is trivial with `pip`: 
```bash
pip install https://gitlab.com/Salvus/SalvusMeshLite/-/archive/master/SalvusMeshLite-master.zip
```
The mesher runs on a single processor, so there is no need to install it on an HPC cluster. It is efficient enough to generate very large-scale meshes on a laptop.

Verify the installation by
```bash
python -m salvus_mesh_lite.interface AxiSEM -h
```
This will display all the arguments one can pass to the mesher. 


## Solver

### 1. Installing dependencies

The `AxiSEM3D` solver is developed on top of the following modern numerical libraries:

Name|Role|Minimum version|Note
--- | --- | ---|---
[`Eigen`](http://eigen.tuxfamily.org/index.php?title=Main_Page) | linear algebra | 3.3.9 | The current stable release 3.3.7 (up to July 2020) is insufficient.
[`Boost`](https://www.boost.org/) | C++ helpers | 1.73.0 | `AxiSEM3D` only uses some of its header-only modules.
[`FFTW`](http://www.fftw.org/) | fast Fourier transform | 3.3.4 | Both single- and double-precision builds are required.
[`Metis`](http://glaros.dtc.umn.edu/gkhome/metis/metis/overview) | mesh partitioning | 5.1.0 | Both 32- and 64-bit builds are acceptable.
[`NetCDF`](https://www.unidata.ucar.edu/software/netcdf/docs/index.html) | efficient multi-dimensional I/O | 4.4.1 | Parallel build is supported but not mandatory.

#### 1.1. Eigen and Boost

`Eigen` and `Boost` are header-only libraries. All one needs to do is to download the source code:
```bash
# create a top working directory and cd in
mkdir -p AxiSEM3D_2020 && cd $_
# create a dependency directory
mkdir -p dependencies
# download Eigen 3.3.9
wget -c https://gitlab.com/libeigen/eigen/-/archive/master/eigen-master.tar.bz2 -O - | tar -jx -C ./dependencies
# download Boost 1.73
wget -c https://dl.bintray.com/boostorg/release/1.73.0/source/boost_1_73_0.tar.bz2 -O - | tar -jx -C ./dependencies
```
The above lines will download `eigen-master` and `boost_1_73_0` under `AxiSEM3D_2020/dependencies`.

<strong>NOTE</strong>: `AxiSEM3D` requires `Eigen` 3.3.9 or above, but the latest stable release is 3.3.7 (up to July 22, 2020). Therefore, the above steps are *essential* even one had `Eigen` installed before.


#### 1.2. FFTW, Metis and NetCDF
On a laptop or workstation, these packages can be easily installed using `conda`:

```bash
# install FFTW
conda install -c conda-forge fftw
# install Metis
conda install -c anaconda metis
# install NetCDF
conda install -c anaconda netcdf4
```

On an HPC cluster, it is most likely that these packages have been installed with an optimized configuration owing to their popularity. On a cluster, the software packages are usually managed by `module`. To browse available packages and versions:
```bash
# show all available packages
module avail
# show all available versions of FFTW
module avail fftw
```

To load a required package, for example, `FFTW` (this is *machine-dependent*):
```bash
# load default FFTW
module load fftw
# load a specific version of FFTW
module load fftw/3.3.8.0
```

If a package is missing, one may 
1. turn to admin for help;
2. install it by `conda` (many clusters allow users to install their own [`Anaconda`](https://docs.anaconda.com/anaconda/install/) or [`Miniconda`](https://docs.conda.io/en/latest/miniconda.html));
3. install it from scratch (see instructions for [`FFTW`](http://www.fftw.org/fftw3_doc/Installation-on-Unix.html), [`Metis`](http://glaros.dtc.umn.edu/gkhome/metis/metis/download) and [`NetCDF`](https://www.unidata.ucar.edu/software/netcdf/docs/getting_and_building_netcdf.html)).




### 2. Building AxiSEM3D
#### 2.1. Download the code
```bash
# download the code (under the top working directory)
rm -rf AxiSEM3D
git clone https://github.com/kuangdai/AxiSEM-3D.git AxiSEM3D
```

#### 2.2. Configure by `cmake`
First, create a `build` directory: 
```bash
# create and cd into build
rm -rf build && mkdir build && cd $_
```
Because `build` must be emptied every time before redoing `cmake`, it is good practice to put nothing under `build` except those automatically generated by `cmake` and `make`. 

Next, run `cmake`, for example:
```bash
# cmake
cmake -Dcc=mpicc -Dcxx=mpicxx -Dftn=mpif90 \
-Deigen=$HOME/AxiSEM3D_2020/dependencies/eigen-master \
-Dboost=$HOME/AxiSEM3D_2020/dependencies/boost_1_73_0 \
-Dfftw=$HOME/anaconda3 \
-Dmetis=$HOME/anaconda3 \
-Dnetcdf=$HOME/anaconda3 \
../AxiSEM3D/SOLVER/
```

It takes the following arguments, passed to `cmake` by `-D` definitions:
Parameter|Role|Default|Note
--- | --- | ---|---
`cc`, `cxx`, `ftn`| C, C++, Fortran compilers | gcc, g++, gfortran | The C++ compiler must support C++17.
`eigen`, `boost`, `fftw`, `metis`, `netcdf`| paths of the dependencies | empty | Such a path should contain both `\lib` and `\include`. To find the path of a package managed by `module`, use `module show` (e.g., `module show fftw`).
`hdf5` | path of `HDF5` | empty | If `NetCDF` has been built as a static library, linking will fail with missing `_H5` symbols. In that case, `-Dhdf5` must be presented, pointing to the HDF5 library used to build `NetCDF`.
`par_netcdf` | to use parallel `NetCDF` or not | false | Parallel `NetCDF` is supported but not mandatory because of its tricky installation.
`flags`|additional compiler flags | empty | Standard flags such as `-O3`, `-DNDEBUG` and `-std=C++1z` will be automatically handled by `cmake`. Different systems and compilers may require different additional flags.
`libs`| additional libraries to link to | empty | For example, `-lcurl` will be required if `NetCDF` has been built statically with remote client support.
`npol`|polynomial order of spectral elements |4| It must be an integer from 1 to 8.
`double` | to compile the solver in double precision or not |false|Using double precision increases memory usage but barely affects solver performance.

These arguments can be hardcoded in `AxiSEM3D/SOLVER/CMakeLists.txt` (unrecommended). Upon a successful `cmake`, a summary will be displayed at the end. Check this summary closely and make sure that the compilers, the flags and the dependencies have been correctly set.

#### 2.3. Compile and link by `make`
To compile and link AxiSEM3D:
```bash
# -j8 means using 8 threads to accelerate compilation
make -j8
```
Finally, one can verify the executable:
```bash
# the number of processors can be arbitrary
mpirun -np 4 ./axisem3d
```
`AxiSEM3D` has been built successfully if an error message appears saying "Missing input directory".

#### 2.4. Complete examples on HPC
* The UK National Supercomputing Service [ARCHER](https://www.archer.ac.uk/):

```bash
#!/bin/bash
# install_AxiSEM3D.sh

# create a top working directory and cd in
mkdir -p AxiSEM3D_2020 && cd $_

# download eigen and boost (check existence before download)
mkdir -p dependencies
[ ! -d ./dependencies/eigen-master ] && \
wget -c https://gitlab.com/libeigen/eigen/-/archive/master/eigen-master.tar.bz2 -O - | tar -jx -C ./dependencies
[ ! -d ./dependencies/boost_1_73_0 ] && \
wget -c https://dl.bintray.com/boostorg/release/1.73.0/source/boost_1_73_0.tar.bz2 -O - | tar -jx -C ./dependencies

# download AxiSEM3D (check existence before download)
[ ! -d ./AxiSEM3D ] && \
git clone https://github.com/kuangdai/AxiSEM-3D.git AxiSEM3D

# use intel; otherwise use gnu
export USE_INTEL=false

# environment modules and variables
if $USE_INTEL; then
  module switch PrgEnv-cray PrgEnv-intel
  module swithc intel intel/17.0.3.191
  export ncdfpath=/opt/cray/netcdf/4.6.1.3/intel/16.0
else
  module switch PrgEnv-cray PrgEnv-gnu
  export ncdfpath=/opt/cray/netcdf/4.6.1.3/GNU/7.1
fi
module switch gcc gcc/7.3.0
module load cmake/3.16.0
export CRAYPE_LINK_TYPE=dynamic

# modules required by AxiSEM3D
module load fftw
module load metis
module load cray-netcdf/4.6.1.3
# On ARCHER, HDF5 is handled by compiler wrappers;
# users only need to load the right version
module load cray-hdf5/1.10.2.0

# cmake
rm -rf build && mkdir build && cd $_
cmake -Dcc=cc -Dcxx=CC -Dftn=ftn \
-Deigen=$(dirname $PWD)/dependencies/eigen-master \
-Dboost=$(dirname $PWD)/dependencies/boost_1_73_0 \
-Dfftw=/opt/cray/fftw/3.3.4.11/ivybridge \
-Dmetis=/work/y07/y07/cse/metis/5.1.0_build2 \
-Dnetcdf=$ncdfpath \
-Dflags=-fPIC ../AxiSEM3D/SOLVER/

# make
make -j8
```



## Tools for pre- and post-processing




[<< Back to repository](https://github.com/kuangdai/AxiSEM-3D)
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE3Mzk4NTUxNzUsOTM3NDAyOTM1LDEyOD
gxODQyMTMsLTgwMTQzNzEzNywxOTgwODEwMDc5LC01OTU5Mjc4
NzUsLTEwNjI2MDk4MjksLTEzNDQyNzkwMSwtNTEwNDYxMDg0LC
0xODkxNzQ4NjU3LC0xMDY1MzIwOTc2LDE4MjcwMzIwNTQsMTIz
MzE4NTA0LC0xMjQ5Nzk5Mjk5LC0xNTQ0NzY2OTA1LC0xNDU3ND
Q1NzY4LDEzMTAyNTA4NSwxNzQ3OTM0Mjc4LC0yMTc1NDI4MzQs
Njg3Nzg5ODQ2XX0=
-->